<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-fanruo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-fanruo.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"m.fanruo.net","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="初心 读书 知新 生活">
<meta property="og:type" content="website">
<meta property="og:title" content="凡 若">
<meta property="og:url" content="https://m.fanruo.net/page/4/index.html">
<meta property="og:site_name" content="凡 若">
<meta property="og:description" content="初心 读书 知新 生活">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Frank Yu">
<meta property="article:tag" content="人工智能 基础架构 读书 人文 经济 历史">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://m.fanruo.net/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>凡 若</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">凡 若</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">初心 读书 知新 生活</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">31</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">44</span></a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="calendar fa-fw"></i>日程表</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/06/18/openresty-%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/18/openresty-%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/" class="post-title-link" itemprop="url">openresty 执行阶段问题踩坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-06-18 14:55:58" itemprop="dateCreated datePublished" datetime="2019-06-18T14:55:58+08:00">2019-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenResty/" itemprop="url" rel="index"><span itemprop="name">OpenResty</span></a>
                </span>
            </span>

          
            <span id="/2019/06/18/openresty-%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/" class="post-meta-item leancloud_visitors" data-flag-title="openresty 执行阶段问题踩坑" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/06/18/openresty-%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/06/18/openresty-%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5%E9%97%AE%E9%A2%98%E8%B8%A9%E5%9D%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>由于业务需求我们需要根据<code>client_ip</code>对部分接口做一个简单的 ab test，将部分流量导新的服务上。基于之前做 WAF 的经验，制定了大体方案：根据 <code>client_ip</code> 做 hash， 根据 hash 值来确定是请求新后端还是原来的后端服务。<br>在说明详细方案前，先说明一下现状。当前的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/api/rest/v\d+/Login &#123;</span><br><span class="line">    rewrite ^(.*)$ /loginServer$1 break;</span><br><span class="line"></span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_next_upstream error timeout invalid_header;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line"></span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header Clientip $http_clientip;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Scheme $scheme;</span><br><span class="line">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Connection &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    proxy_pass http://test.fanruo.net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>/loginServer</code>是当前服务路径前缀，<code>/loginServerNew</code>是新服务路径前缀。所以，具体需求可以描述为，10% 的用户使用<code>/loginServerNew</code>服务，90% 的用户使用<code>/loginServer</code>服务。</p>
<h3 id="具体方案"><a href="#具体方案" class="headerlink" title="具体方案"></a>具体方案</h3><ol>
<li>根据字符串 client_ip 转成长整数 ip_num;</li>
<li>对 ip_num 按 100 取模，取最后两位 hash；</li>
<li>当 hash &lt; 10 时走<code>/loginServerNew</code>服务， 设置 <code>tag=&quot;New&quot;</code>, 否则 <code>tag=&quot;&quot;</code></li>
<li>改造<code>rewrite</code>指令为<code> rewrite ^(.*)$ /loginServer$tag$1 break;</code></li>
</ol>
<p>对应配置为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/api/rest/v\d+/Login &#123;</span><br><span class="line">    set $tag &quot;&quot;;</span><br><span class="line">    access_by_lua_file conf/lua/abtest.lua;</span><br><span class="line">    rewrite ^(.*)$ /loginServer$tag$1 break;</span><br><span class="line"></span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_next_upstream error timeout invalid_header;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line"></span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header Clientip $http_clientip;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Scheme $scheme;</span><br><span class="line">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Connection &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    proxy_pass http://test.fanruo.net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>对应 lua 脚本（conf&#x2F;lua&#x2F;btest.lua）：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> client_ip = ngx.var.http_clientip <span class="keyword">or</span> ngx.var.remote_addr</span><br><span class="line"><span class="keyword">local</span> o1,o2,o3,o4 = client_ip:<span class="built_in">match</span>(<span class="string">&quot;(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)&quot;</span> )</span><br><span class="line"><span class="keyword">local</span> ip_num = <span class="number">2</span>^<span class="number">24</span>*o1 + <span class="number">2</span>^<span class="number">16</span>*o2 + <span class="number">2</span>^<span class="number">8</span>*o3 + o4</span><br><span class="line"><span class="keyword">local</span> hash = ip_num % <span class="number">100</span></span><br><span class="line"></span><br><span class="line">ngx.var.tag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> hash &gt; <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">    ngx.var.tag = <span class="string">&quot;New&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>按照上述实现，最终总是走原来的服务<code>/loginServer</code>。通过分析 tag 的值一直是 “”，因此，需求不能满足。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>通过分析，由于之前 WAF 是通过直接修改 proxy_pass 参数来完成的，而 proxy_pass 对应 content phase，该阶段在 access phase 之后，因此上面的配置没有问题。而本需求是在 rewrite phase，因此需要在该阶段之前修改对应变量 tag 只能在 set phase 来完成 nginx 变量修改操作。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>跟进上述分析，修改 nginx.conf 配置和 lua 脚本如下：</p>
<p>lua 脚本修改为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> client_ip = ngx.var.http_clientip <span class="keyword">or</span> ngx.var.remote_addr</span><br><span class="line"><span class="keyword">local</span> o1,o2,o3,o4 = client_ip:<span class="built_in">match</span>(<span class="string">&quot;(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)%.(%d%d?%d?)&quot;</span> )</span><br><span class="line"><span class="keyword">local</span> ip_num = <span class="number">2</span>^<span class="number">24</span>*o1 + <span class="number">2</span>^<span class="number">16</span>*o2 + <span class="number">2</span>^<span class="number">8</span>*o3 + o4</span><br><span class="line"><span class="keyword">local</span> hash = ip_num % <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> tag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> hash &gt; <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">    tag = <span class="string">&quot;New&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> tag</span><br></pre></td></tr></table></figure>


<p>nginx.conf 配置修改为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/api/rest/v\d+/Login &#123;</span><br><span class="line">    set_by_lua_file $tag conf/lua/abtest.lua;</span><br><span class="line">    rewrite ^(.*)$ /loginServer$tag$1 break;</span><br><span class="line"></span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_next_upstream error timeout invalid_header;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line"></span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header Clientip $http_clientip;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Scheme $scheme;</span><br><span class="line">    proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header Connection &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    proxy_pass http://test.fanruo.net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/29/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx-%E7%BB%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/29/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx-%E7%BB%AD/" class="post-title-link" itemprop="url">nginx + lua 开发中过程中 post body 过大返回 4xx (续)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-29 09:21:00" itemprop="dateCreated datePublished" datetime="2019-05-29T09:21:00+08:00">2019-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nginx/OpenResty/" itemprop="url" rel="index"><span itemprop="name">OpenResty</span></a>
                </span>
            </span>

          
            <span id="/2019/05/29/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx-%E7%BB%AD/" class="post-meta-item leancloud_visitors" data-flag-title="nginx + lua 开发中过程中 post body 过大返回 4xx (续)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/29/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx-%E7%BB%AD/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/29/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx-%E7%BB%AD/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>746</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>随着业务发展会出现较大的 post body 数据，按照<a href="/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/" title="nginx + lua 开发中过程中 post body 过大返回 4xx">nginx + lua 开发中过程中 post body 过大返回 4xx</a>提到的方式修改后，大部分情况下 post body 正常接收并处理落日志。但会偶现空日志的情况。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>经过多轮本地和沙盒压测，复现了问题。由于在出现空日志情况是 error 日志并没留下相关信息，随后做了如下处理：</p>
<ol>
<li>把 error 日志级别调到 debug，当问题复现时，error.log 中会有客户端过早断开连接类似的日子打出。</li>
<li>在 access 日志中添加 request_time, status,等信息，发现出现空日志时，status&#x3D;408，request_time 都比较长。</li>
</ol>
<p>因此，可以明确出现该问题是客户端链接超时造成的。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>为解决该问题，做如下优化：</p>
<h3 id="调整超时时间，和-buffer"><a href="#调整超时时间，和-buffer" class="headerlink" title="调整超时时间，和 buffer"></a>调整超时时间，和 buffer</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout 10s;</span><br><span class="line">client_header_timeout 10s;</span><br><span class="line">client_body_in_single_buffer on; #这个 directive 让 Nginx 将所有的 request body 存储在一个缓冲当中，它的默认值是 off。启用它可以优化读取 $request_body 变量时的 I/O 性能</span><br></pre></td></tr></table></figure>
<h3 id="开启-access-buffer-和-if"><a href="#开启-access-buffer-和-if" class="headerlink" title="开启 access buffer 和 if"></a>开启 access buffer 和 if</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log_format  main escape=json &#x27;[$log_time] [$logid] [INFO] $click_info&#x27;;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置变量loggable，默认<span class="variable">$loggable</span>=0;当<span class="variable">$status</span>==200时，<span class="variable">$loggable</span>=1</span></span><br><span class="line">map $status $loggable &#123;</span><br><span class="line">	200  1;</span><br><span class="line">    default 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有真确处理了请求才会写日志。客户端在收到 408 时，会将 body 拆分重传。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/" class="post-title-link" itemprop="url">nginx + lua 开发中过程中 post body 过大返回 4xx</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-28 18:52:53" itemprop="dateCreated datePublished" datetime="2019-05-28T18:52:53+08:00">2019-05-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Nginx/OpenResty/" itemprop="url" rel="index"><span itemprop="name">OpenResty</span></a>
                </span>
            </span>

          
            <span id="/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/" class="post-meta-item leancloud_visitors" data-flag-title="nginx + lua 开发中过程中 post body 过大返回 4xx" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/28/nginx-lua-%E5%BC%80%E5%8F%91%E4%B8%AD%E8%BF%87%E7%A8%8B%E4%B8%AD-post-body-%E8%BF%87%E5%A4%A7%E8%BF%94%E5%9B%9E-4xx/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>551</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>基于 OpenResty 提供 post 接口，调用方调用该接口 post 数据，该接口接收 post 过来的数据，复用 Nginx access 日志落盘。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>当用户的 body 体过大时，<code>ngx.req.get_body_data()</code> 读请求体，会出现读取不到直接返回 <code>nil</code> 的情况。</p>
<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>究其原因，主要是 Nginx 诞生之初主要是为了解决负载均衡情况，而这种情况，是不需要读取 body 就可以决定负载策略的，所以这个点对于 API Server 和 Web Application 开发的同学有点怪。</p>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><ol>
<li>如果你只是某个接口需要读取 body（并非全局行为），那么这时候也可以显示调用 <code>ngx.req.read_body()</code> 接口</li>
<li>如果想全局生效的话需要使用命令<code>lua_need_request_body on;</code></li>
</ol>
<p>当选择上述其中一种，甚至两种方案都使用了，依旧还解决不了问题，这时候，需要坚持 body 体是不是太大了。这是需要设置如下两个命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size 256k; #默认8k|16k</span><br><span class="line">client_max_body_size 256k; #默认1m</span><br></pre></td></tr></table></figure>
<p>上述两条命令将强制将 body 写入内存，这样就可以读取较大的 body 体的数据了。</p>
<p>如果请求体已经被存入临时文件，请使用<code>ngx.req.get_body_file</code>函数代替。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/24/3-1-lua-%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/24/3-1-lua-%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">3.1 lua 函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-24 10:52:03" itemprop="dateCreated datePublished" datetime="2019-05-24T10:52:03+08:00">2019-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
            <span id="/2019/05/24/3-1-lua-%E5%87%BD%E6%95%B0/" class="post-meta-item leancloud_visitors" data-flag-title="3.1 lua 函数" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/24/3-1-lua-%E5%87%BD%E6%95%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/24/3-1-lua-%E5%87%BD%E6%95%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>通过前两章的学习大体掌握了lua的基本语法，这部分语法和其他语言大体类似，可以说这是一门语言语法的最最基础的部分了。在接下来的部分，将学习一下带有lua特性的语法知识。</p>
<h2 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h2><p>通常一个函数会返回一个返回值，比如C&#x2F;C++等，也有一些语言会返回多个返回值，比如python。lua也支持多返回值。以标准库中的<code>string.find()</code>函数为例，该函数会返回匹配字符串在搜索字符串中的<strong>起始</strong>位置索引，如果没匹配成功则返回<code>nil</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/bua</span><br><span class="line">s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">&quot;hello world&quot;</span>, <span class="string">&quot;he&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s, e)</span><br></pre></td></tr></table></figure>
<p>对于返回值，lua有一个特性——尽可能的调整返回值的数量以适应调用环境，具体表现为一下规则：</p>
<ol>
<li>当作为调用表达式最后一个参数或者仅有的一个参数时，根据变量的数量尽可能多的返回值，当变量数目大余于返回值数目时补<code>nil</code>，当变量数小于返回值数目时从左到右依此返回，舍弃右边多余的返回值。</li>
<li>其他情况下，函数只返回第一个返回值。<br>总之，函数做作为最后一个参数时尽可能多返回返回值，其他情况只返回第一个返回值。<br>上述规则同样适用于以下情况：</li>
<li>作为表达式赋值给其他变量</li>
<li>作为其他函数的参数</li>
<li>函数调用在表构造初始化时</li>
<li>ruturn 参数<br>函数调用用在表构造初始化时需要特别说明一下：<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun_0</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun_1</span><span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&quot;a&quot;</span> <span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun_2</span><span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = &#123;fun_0()&#125; <span class="comment">-- a = &#123;&#125;</span></span><br><span class="line">b = &#123;fun_1()&#125; <span class="comment">-- b = &#123;&quot;a&quot;&#125;</span></span><br><span class="line">c = &#123;fun_2()&#125; <span class="comment">-- c = &#123;&quot;b&quot;, &quot;c&quot;&#125;</span></span><br><span class="line">d = &#123;fun_0(), fun_1(), fun_2(), <span class="string">&quot;d&quot;</span>&#125; <span class="comment">-- d = &#123;nil, &quot;a&quot;, &quot;b&quot;, &quot;d&quot;&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>注意</strong>：如果<code>return</code>语句中将返回值用括号包裹起来也会导致返回一个值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun_3</span><span class="params">()</span></span> <span class="keyword">return</span> fun_2() <span class="keyword">end</span>  <span class="comment">-- &quot;b&quot;, &quot;c&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun_4</span><span class="params">()</span></span> <span class="keyword">return</span> (fun_2()) <span class="keyword">end</span> <span class="comment">-- &quot;b&quot;</span></span><br></pre></td></tr></table></figure>


<h2 id="函数的定义"><a href="#函数的定义" class="headerlink" title="函数的定义"></a>函数的定义</h2><p>lua中函数是一等变量，可以通过关键字<code>function</code>来进行定义。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 和php等语言一样使用function关键字声明一个函数</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func_a</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在lua中函数也是一等变量，可以通过如下方式来声明一个函数</span></span><br><span class="line"><span class="keyword">local</span> func_b = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>和其他语言一样，在lua中，声明一个函数可以指定固定数目的参数，这些参数不需要指定类型。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">a</span><span class="params">(a, b)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><p>同样,lua也支持可变参数，使用<code>...</code>来表示可变参数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func_a</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(args) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--5.3.4中已不支持arg表了，改用...代替,见programing in lua 4th pp45</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func_b</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(...) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>有时，我们会遇到这样一种情况：既需要若干固定参数，但还需要可变参数。这时我们需要将固定参数列在参数列表的最左边，可变参数<code>...</code>放在最右边。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func_c</span><span class="params">(a, b, ...)</span></span></span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="命名参数"><a href="#命名参数" class="headerlink" title="命名参数"></a>命名参数</h3><p>和其他语言一样，lua的参数和位置是相关的，函数调用时，实参会按照位置依次传递给形参。但是，有时我们记不住形参的具体位置就有麻烦了。命名参数就很好的解决了这个问题。<br>但是，和c++等语言的命名参数不一样，lua的命名参数是通过table来实现的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/23/2-6-lua-break-%E4%B8%8E-return/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/23/2-6-lua-break-%E4%B8%8E-return/" class="post-title-link" itemprop="url">2.6 lua break 与 return</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-23 08:56:53" itemprop="dateCreated datePublished" datetime="2019-05-23T08:56:53+08:00">2019-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
            <span id="/2019/05/23/2-6-lua-break-%E4%B8%8E-return/" class="post-meta-item leancloud_visitors" data-flag-title="2.6 lua break 与 return" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/23/2-6-lua-break-%E4%B8%8E-return/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/23/2-6-lua-break-%E4%B8%8E-return/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>902</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>和其他语言一样<code>lua</code>也提供对应的跳出关键字，不过<code>lua</code>不提供<code>continue</code>关键字。</p>
<h2 id="break"><a href="#break" class="headerlink" title="break"></a>break</h2><p>语句<code>break</code>用于跳出循环，终止<code>for</code>、<code>repeat</code>、<code>while</code> 三种循环的执行，并跳出当前循环体，继续执行当前循环之后的语句,在循环外部不可用。</p>
<h2 id="return"><a href="#return" class="headerlink" title="return"></a>return</h2><p>return 只能写在语句块的最后，一旦执行了return 语句，该语句之后的所有语句都不会再执行。若要写在函数中间，则只能写在一个显式的语句块内。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(x, y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">    <span class="comment">--print(&quot;add: I will return the result &quot; .. (x + y))</span></span><br><span class="line">    <span class="comment">--因为前面有个return，若不注释该语句，则会报错</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">is_positive</span><span class="params">(x)</span></span></span><br><span class="line">    <span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> x .. <span class="string">&quot; is positive&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> x .. <span class="string">&quot; is non-positive&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--由于return只出现在前面显式的语句块，所以此语句不注释也不会报错</span></span><br><span class="line">    <span class="comment">--，但是不会被执行，此处不会产生输出</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;function end!&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">sum = add(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The sum is &quot;</span> .. sum) <span class="comment">--&gt;output:The sum is 30</span></span><br><span class="line">answer = is_positive(<span class="number">-10</span>)</span><br><span class="line"><span class="built_in">print</span>(answer) <span class="comment">--&gt;output:-10 is non-positive</span></span><br></pre></td></tr></table></figure>
<p>有时候，为了调试方便，我们可以想在某个函数的中间提前 <code>return</code> ，以进行控制流的短路。此时我们可以将 <code>return</code> 放在一个 <code>do ... end</code> 代码块中:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;before&quot;</span>)</span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;after&quot;</span>) <span class="comment">-- 这一行语句永远不会执行到</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>特别注意</strong>：上述实例中<code>return</code>如果不放在<code>do ... end</code>中将会保存，因为<code>return</code>只能放在函数的最后。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/21/2-5-lua-%E5%8F%98%E9%87%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/21/2-5-lua-%E5%8F%98%E9%87%8F/" class="post-title-link" itemprop="url">2.5 lua 变量</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-21 22:05:37" itemprop="dateCreated datePublished" datetime="2019-05-21T22:05:37+08:00">2019-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
            <span id="/2019/05/21/2-5-lua-%E5%8F%98%E9%87%8F/" class="post-meta-item leancloud_visitors" data-flag-title="2.5 lua 变量" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/21/2-5-lua-%E5%8F%98%E9%87%8F/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/21/2-5-lua-%E5%8F%98%E9%87%8F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>940</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><h3 id="创建一个全局变量"><a href="#创建一个全局变量" class="headerlink" title="创建一个全局变量"></a>创建一个全局变量</h3><p>全局变量不需要声明，给一个变量赋值即创建了一个全局变量，访问一个没有初始化的变量（默认是全局变量，即，lua的变量默认是全局变量，特别注意）也不会出错，会返回<code>nil</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(var_a) <span class="comment">-- nil</span></span><br><span class="line">var_a = <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(var_a) <span class="comment">-- 10</span></span><br></pre></td></tr></table></figure>
<p>在命令模式中执行如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Lua 5.3.4  Copyright (C) 1994-2017 Lua.org, PUC-Rio</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">print</span>(var_a)</span></span><br><span class="line">nil</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="删除一个全局变量"><a href="#删除一个全局变量" class="headerlink" title="删除一个全局变量"></a>删除一个全局变量</h3><p>删除一个变量很简单，直接将改变量赋值为<code>nil</code>;如下面的例子：b是全局变量，当赋值为<code>nil</code>之后，再调用<code>print</code>就会返回<code>nil</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Lua 5.3.4  Copyright (C) 1994-2017 Lua.org, PUC-Rio</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">b = 1; <span class="built_in">print</span>(<span class="string">&quot;b=&quot;</span> .. b); b = nil; <span class="built_in">print</span>(b);</span></span><br><span class="line">b=1</span><br><span class="line">nil</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>
<p>总之，可以这么理解：当一个变量被赋值为<code>nil</code>，这个变量就变得像从来没出现过一样，换句话说，<strong>只有当一个变量的值不是<code>nil</code>这个变量才是存在的</strong>。</p>
<h2 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h2><p>使用<code>local</code> 关键字来声明一个局部变量，和其他语言一样，局部变量只在被声明的那个代码块中有效。代码块包括：</p>
<ol>
<li>控制结构</li>
<li>函数体</li>
<li>chunk（变量被声明的那个文件或者文本串</li>
</ol>
<p><strong>注意</strong>:命令行模式中每一行就是一个chunk,也就是说，上一行的局部变量下一行就不可见了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lua 5.3.4  Copyright (C) 1994-2017 Lua.org, PUC-Rio</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">a = 1 -- 全局变量</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">print</span>(a)</span></span><br><span class="line">1</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">local</span> b = 2 -- 局部变量</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">print</span>(b)</span></span><br><span class="line">nil</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用do-end"><a href="#使用do-end" class="headerlink" title="使用do ... end"></a>使用<code>do ... end</code></h3><p>使用<code>do ... end</code>可以给一个block一个明确的边界。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Lua 5.3.4  Copyright (C) 1994-2017 Lua.org, PUC-Rio</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">a = 1 --全局变量</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">local</span> b = 2 -- 局部变量</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="keyword">do</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt; <span class="built_in">local</span> c = a * 3 --局部变量</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt; <span class="built_in">print</span>(a)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt; <span class="built_in">print</span>(b)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt; <span class="built_in">print</span>(c)</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt; end</span></span><br><span class="line">1</span><br><span class="line">nil</span><br><span class="line">3</span><br><span class="line"><span class="meta prompt_">&gt;</span></span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/21/2-4-lua-%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/21/2-4-lua-%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">2.4 lua 控制结构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-21 08:48:37" itemprop="dateCreated datePublished" datetime="2019-05-21T08:48:37+08:00">2019-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
            <span id="/2019/05/21/2-4-lua-%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84/" class="post-meta-item leancloud_visitors" data-flag-title="2.4 lua 控制结构" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/21/2-4-lua-%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/21/2-4-lua-%E6%8E%A7%E5%88%B6%E7%BB%93%E6%9E%84/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>流程控制语句对于程序设计来说特别重要，它可以用于设定程序的逻辑结构。一般需要与条件判断语句结合使用。Lua 语言提供的控制结构有 if，while，repeat，for，并提供 break 关<br>键字来满足更丰富的需求。</p>
<h2 id="if-x2F-else"><a href="#if-x2F-else" class="headerlink" title="if&#x2F;else"></a>if&#x2F;else</h2><p>if-else 是我们熟知的一种控制结构。Lua 跟其他语言一样，提供了 if-else 的控制结构。语法上更接近shell的语言，逻辑结构上和其他语言没有较大的区别，直接上实例，一看便知。</p>
<h3 id="单分支if-end"><a href="#单分支if-end" class="headerlink" title="单分支if-end"></a>单分支if-end</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;x is a positive number&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--运行输出：x is a positive number</span></span><br></pre></td></tr></table></figure>
<h3 id="双分支if-else-end"><a href="#双分支if-else-end" class="headerlink" title="双分支if-else-end"></a>双分支if-else-end</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">if</span> x &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;x is a positive number&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;x is a non-positive number&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--运行输出：x is a positive number</span></span><br></pre></td></tr></table></figure>
<h3 id="多分支if-elseif-else-end"><a href="#多分支if-elseif-else-end" class="headerlink" title="多分支if-elseif-else-end"></a>多分支if-elseif-else-end</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">score = <span class="number">90</span></span><br><span class="line"><span class="keyword">if</span> score == <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Very good!Your score is 100&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> score &gt;= <span class="number">60</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Congratulations, you have passed it,your score greater or equal to 60&quot;</span>)</span><br><span class="line"><span class="comment">--此处可以添加多个elseif</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sorry, you do not pass the exam! &quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--运行输出：Congratulations, you have passed it,your score greater or equal to 60</span></span><br></pre></td></tr></table></figure>

<p>**特别注意|**与 C 语言的不同之处是 else 与 if 是连在一起的，若将 else 与 if 写成 “else if” 则相当于在else 里嵌套另一个 if 语句，如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">score = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> score == <span class="number">100</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Very good!Your score is 100&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> score &gt;= <span class="number">60</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Congratulations, you have passed it,your score greater or equal to 60&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> score &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Your score is better than 0&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;My God, your score turned out to be 0&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span> <span class="comment">--与上一示例代码不同的是，此处要添加一个end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从上述实例中可以发现，除了<code>else if</code>这种形式较<code>elseif</code>多了一个<code>end</code>外看起来并没有什么区别。上述实例中<code>else if</code>在判断的最后，如果在中间的话，意味着后面的<code>elseif</code>将会出现语法错误。</p>
<h2 id="while"><a href="#while" class="headerlink" title="while"></a>while</h2><p>Lua 跟其他常见语言一样，提供了 <code>while</code> 控制结构，语法上也没有什么特别的。但是没有提供do-while 型的控制结构，但是提供了功能相当的 <code>repeat</code>。<br><code>while</code> 型控制结构语法如下，当表达式值为假（ 即 <code>false</code> 或 <code>nil</code>） 时结束循环。也可以使用break 语言提前跳出循环。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> 表达式 <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--示例代码，求 1 + 2 + 3 + 4 + 5 的结果</span></span><br><span class="line">x = <span class="number">1</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> x &lt;= <span class="number">5</span> <span class="keyword">do</span></span><br><span class="line">    sum = sum + x</span><br><span class="line">    x = x + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(sum) <span class="comment">--&gt;output 15</span></span><br></pre></td></tr></table></figure>
<p><strong>特别注意：</strong><br>Lua 并没有像许多其他语言那样提供类似 <code>continue</code> 这样的控制语句用来立即进入下一个循环迭代（ 如果有的话） 。因此，我们需要仔细地安排循环体里的分支，以避免这样的需求。</p>
<p>没有提供 <code>continue</code> ，却也提供了另外一个标准控制语句 <code>break</code> ，可以跳出当前循环。例如遍历 <code>table</code>，查找值为 <code>11</code> 的数组下标索引:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = &#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">11</span>, <span class="number">18</span>, <span class="number">21</span>&#125;</span><br><span class="line"><span class="keyword">local</span> i</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">11</span> == v <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index[&quot;</span> .. i .. <span class="string">&quot;] have right value[11]&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="repeat"><a href="#repeat" class="headerlink" title="repeat"></a>repeat</h2><p>Lua 中的 <code>repeat</code> 控制结构类似于其他语言（ 如：C++ 语言） 中的 do-while，但是控制方式是刚好相反的。简单点说，执行 <code>repeat</code> 循环体后，直到 <code>until</code> 的条件为<strong>真</strong>时才结束，而其他语言（ 如：C++ 语言） 的 do-while 则是当条件为假时就结束循环。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"><span class="keyword">until</span> <span class="literal">false</span></span><br><span class="line"><span class="comment">--该代码将导致死循环，因为until的条件一直为假，循环不会结束</span></span><br></pre></td></tr></table></figure>
<p>除了条件相反外，<code>repeat</code>和<code>while</code>是一样的。</p>
<h2 id="for"><a href="#for" class="headerlink" title="for"></a>for</h2><p>for 语句有两种形式：数字 for（ numeric for） 和范型 for（ generic for）。</p>
<h3 id="数字for"><a href="#数字for" class="headerlink" title="数字for"></a>数字for</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var = begin, finish, step <span class="keyword">do</span></span><br><span class="line">    <span class="comment">--body</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>关于数字 for 需要关注以下几点:</p>
<ol>
<li>var 从 begin 变化到 finish，每次变化都以 step 作为步长递增 var;</li>
<li>begin、finish、step 三个表达式只会在循环开始时执行一次;</li>
<li>第三个表达式 step是可选的，默认为 1;</li>
<li>控制变量 var 的作用域仅在 for 循环内，需要在外面控制，则需将值赋给一个新的变量;</li>
<li>循环过程中不要改变控制变量的值，那样会带来不可预知的影响.</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">10</span>, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>如果不想给循环设置上限的话，可以使用常量 math.huge：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0.3</span>*i^<span class="number">3</span> - <span class="number">20</span>*i^<span class="number">2</span> - <span class="number">500</span> &gt;=<span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="泛型for"><a href="#泛型for" class="headerlink" title="泛型for"></a>泛型for</h3><p>泛型 for 循环通过一个迭代器（ iterator） 函数来遍历所有值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印数组a的所有值</span></span><br><span class="line"><span class="keyword">local</span> a = &#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;index:&quot;</span>, i, <span class="string">&quot; value:&quot;</span>, v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index: 1 value: a</span><br><span class="line">index: 2 value: b</span><br><span class="line">index: 3 value: c</span><br><span class="line">index: 4 value: d</span><br></pre></td></tr></table></figure>
<p>注意到在上述实例中使用到<code>ipairs</code>函数。Lua 的基础库提供了<code>ipairs</code>，这是一个用于遍历<strong>数组</strong>的迭代器函数。在每次循环中，i 会被赋予一个索引值，同时 v 被赋予一个对应于该索引的数组元素值。那么如何遍历<code>table</code>呢？lua提供了<code>pairs</code>函数可以遍历<code>tbale</code>中的<code>key</code>.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打印table t中所有的key</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从外观上看泛型 for 比较简单，但其实它是非常强大的。通过不同的迭代器，几乎可以遍历所有的东西， 而且写出的代码极具可读性。标准库提供了几种迭代器，包括用于迭代文件中每行的（ io.lines） 、 迭代 table 元素的（ pairs） 、迭代数组元素的（ ipairs） 、迭代字符串中单词的（ string.gmatch） 等。<br>泛型 for 循环与数字型 for 循环有两个相同点:</p>
<ol>
<li>循环变量是循环体的局部变量；</li>
<li>决不应该对循环变量作任何赋值。</li>
</ol>
<p><strong>特别注意：</strong>在 LuaJIT 2.1 中， ipairs() 内建函数是可以被 JIT 编译的，而 pairs() 则只能被解释执行。因此在性能敏感的场景，应当合理安排数据结构，避免对哈希表进行遍历。事实上，即使未来 pairs 可以被 JIT 编译，哈希表的遍历本身也不会有数组遍历那么高效，毕竟哈希表就不是为遍历而设计的数据结构。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/20/librdkafka-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/20/librdkafka-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">librdkafka 安装与使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-20 08:53:02" itemprop="dateCreated datePublished" datetime="2019-05-20T08:53:02+08:00">2019-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a>
                </span>
            </span>

          
            <span id="/2019/05/20/librdkafka-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-meta-item leancloud_visitors" data-flag-title="librdkafka 安装与使用" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/20/librdkafka-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/20/librdkafka-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="安装-librdkafka"><a href="#安装-librdkafka" class="headerlink" title="安装 librdkafka"></a>安装 librdkafka</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/edenhill/librdkafka.git ./librdkafka</span><br><span class="line">cd ./librdkafka</span><br><span class="line">./configure</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Or, to automatically install dependencies using the system<span class="string">&#x27;s package manager:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">./configure --install-deps</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Or, build dependencies from source:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">./configure --install-deps --source-deps-only</span></span></span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h2 id="使用-librdkafka"><a href="#使用-librdkafka" class="headerlink" title="使用 librdkafka"></a>使用 librdkafka</h2><p>librdkafka 中自带 examples，cpp 目录下是 C++ 版本的包括两个 cpp 文件：consumer.cpp 和 producer.cpp，即生产者和消费者。修改其中 <code>brokers</code> 变量和 <code>topic_str</code> 变量的值。</p>
<p>consumer.cpp 文件的第58~63行修改如下（只修改了59行和61行，为看起来直观一些多粘了几行）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//broker 列表，可以用逗号隔开，只写其中一个也可以，这是线下测试环境</span></span><br><span class="line">std::string brokers = <span class="string">&quot;10.159.1.40:19092,10.159.1.41:19092,10.159.1.42:19092&quot;</span>;</span><br><span class="line">std::string errstr;</span><br><span class="line">std::string topic_str=<span class="string">&quot;test_mq&quot;</span>;</span><br><span class="line">std::vector&lt;std::string&gt; topics;</span><br><span class="line">topics.<span class="built_in">push_back</span>(topic_str);</span><br></pre></td></tr></table></figure>
<p>producer.cpp 文件的第31~34行修改如下（只修改了32行和34行，为看起来直观一些多粘了几行）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//broker 列表，可以用逗号隔开，只写其中一个也可以，这是线下测试环境</span></span><br><span class="line">std::string brokers = <span class="string">&quot;10.159.1.40:19092,10.159.1.41:19092,10.159.1.42:19092&quot;</span>;</span><br><span class="line">std::string errstr;</span><br><span class="line">std::string topic_str=<span class="string">&quot;test_mq&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>编译 consumer.cpp 和 producer.cpp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/librdkafka/examples/cpp</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">g++ -o consumer consumer.cpp -lrdkafka++ -lrdkafka -lstdc++ -lbaas_c_style_interface -I~/librdkafka/include -L~/librdkafka/lib</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">g++ -o producer producer.cpp -lrdkafka++ -lrdkafka -lstdc++ -lbaas_c_style_interface -I~/librdkafka/include -L~/librdkafka/lib</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行 producer 和 consumer （控制台交互式的程序，需要开两个窗口）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~/librdkafka/examples/cpp</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./producer</span></span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">Created producer rdkafka<span class="comment">#producer-1</span></span></span><br><span class="line">hello world</span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">Produced message (11 bytes)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./consumer</span></span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">Created consumer rdkafka<span class="comment">#consumer-1</span></span></span><br><span class="line">Read msg at offset 7</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/20/%E6%90%AD%E5%BB%BA-kafka-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/20/%E6%90%AD%E5%BB%BA-kafka-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">搭建 kafka 测试集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-20 00:02:21" itemprop="dateCreated datePublished" datetime="2019-05-20T00:02:21+08:00">2019-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a>
                </span>
            </span>

          
            <span id="/2019/05/20/%E6%90%AD%E5%BB%BA-kafka-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/" class="post-meta-item leancloud_visitors" data-flag-title="搭建 kafka 测试集群" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/20/%E6%90%AD%E5%BB%BA-kafka-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/20/%E6%90%AD%E5%BB%BA-kafka-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="申请机器"><a href="#申请机器" class="headerlink" title="申请机器"></a>申请机器</h2><p>联系OP同学申请机器，Linux服务器一台、三台、五台、（2*n+1），Zookeeper集群的工作是超过半数才能对外提供服务，3台中超过两台超过半数，允许1台挂掉 ，是否可用偶数，其实没必要。<br><strong>如果有四台那么挂掉一台还剩下三台服务器，如果在挂掉一个就不行了，这里记住是超过半数</strong>。<br>找到如下 3 台机器：</p>
<blockquote>
<p>10.159.1.40<br>10.159.1.41<br>10.159.1.42</p>
</blockquote>
<h2 id="安装基础环境"><a href="#安装基础环境" class="headerlink" title="安装基础环境"></a>安装基础环境</h2><p>安装Java环境支持，需要安装sun-java8，不再赘述。</p>
<h2 id="目录规划"><a href="#目录规划" class="headerlink" title="目录规划"></a>目录规划</h2><p>首先要注意在生产环境中目录结构要定义好，防止在项目过多的时候找不到所需的项目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">pwd</span></span></span><br><span class="line">/home/work</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> opt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> opt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> zookeeper</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> kafka</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree -L 1</span></span><br><span class="line">.</span><br><span class="line">├── kafka</span><br><span class="line">└── zookeeper</span><br><span class="line"></span><br><span class="line">2 directories, 0 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="搭建zookeeper集群"><a href="#搭建zookeeper集群" class="headerlink" title="搭建zookeeper集群"></a>搭建zookeeper集群</h2><h3 id="安装配置zookeeper"><a href="#安装配置zookeeper" class="headerlink" title="安装配置zookeeper"></a>安装配置zookeeper</h3><h4 id="安装zookeeper"><a href="#安装zookeeper" class="headerlink" title="安装zookeeper"></a>安装zookeeper</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">pwd</span></span></span><br><span class="line">/home/work</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.13/zookeeper-3.4.13.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果机器没有外网权限需要通过scp等方法来获取zookeeper-3.4.13.tar.gz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/work/opt/zookeeper</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -zxvf /home/work/zookeeper-3.4.13.tar.gz</span></span><br><span class="line">mkdir zkdata #存放快照日志</span><br><span class="line">mkdir zkdatalog #存放事物日志</span><br></pre></td></tr></table></figure>

<h4 id="配置zookeeper"><a href="#配置zookeeper" class="headerlink" title="配置zookeeper"></a>配置zookeeper</h4><p>查看conf目录，在该目录zoo_sample.cfg文件是官方给我们的zookeeper的样板文件，给他复制一份命名为zoo.cfg，zoo.cfg是官方指定的文件命名规则。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /home/work/opt/zookeeper/zookeeper-3.4.13/conf/ -<span class="built_in">tr</span></span></span><br><span class="line">total 16</span><br><span class="line">-rw-r--r-- 1 work work  922 Jun 30 01:04 zoo_sample.cfg</span><br><span class="line">-rw-r--r-- 1 work work 2161 Jun 30 01:04 log4j.properties</span><br><span class="line">-rw-r--r-- 1 work work  535 Jun 30 01:04 configuration.xsl</span><br></pre></td></tr></table></figure>
<p>修改<code>zoo.cfg</code>文件内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that the initial</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of ticks that can pass between</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">example sakes.</span></span><br><span class="line">dataDir=/home/work/opt/zookeeper/zkdata</span><br><span class="line">dataLogDir=/home/work/opt/zookeeper/zkdatalog</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=12181</span><br><span class="line">server.1=10.159.1.40:12888:13888</span><br><span class="line">server.2=10.159.1.41:12888:13888</span><br><span class="line">server.3=10.159.1.42:12888:13888</span><br></pre></td></tr></table></figure>

<h4 id="创建myid文件"><a href="#创建myid文件" class="headerlink" title="创建myid文件"></a>创建myid文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在server1上执行</span></span><br><span class="line">echo &quot;1&quot; &gt; /home/work/opt/zookeeper/zkdata/myid</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在server2上执行</span></span><br><span class="line">echo &quot;2&quot; &gt; /home/work/opt/zookeeper/zkdata/myid</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在server3上执行</span></span><br><span class="line">echo &quot;3&quot; &gt; /home/work/opt/zookeeper/zkdata/myid</span><br></pre></td></tr></table></figure>

<h3 id="确认zookeeper是否部署成功"><a href="#确认zookeeper是否部署成功" class="headerlink" title="确认zookeeper是否部署成功"></a>确认zookeeper是否部署成功</h3><h4 id="启动zookeeper"><a href="#启动zookeeper" class="headerlink" title="启动zookeeper"></a>启动zookeeper</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入到Zookeeper的bin目录下</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/work/opt/zookeeper/zookeeper-3.4.13/bin</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务（3台都需要操作）</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./zkServer.sh start</span></span><br></pre></td></tr></table></figure>
<h4 id="检查是否启动成功"><a href="#检查是否启动成功" class="headerlink" title="检查是否启动成功"></a>检查是否启动成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查服务器状态</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./zkServer.sh status</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /home/work/opt/zookeeper/zookeeper-3.4.13/bin/../conf/zoo.cfg # 使用的具体配置文件</span><br><span class="line">Mode: follower #是否为leaderzk</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>集群一般只有一个leader，多个follower，主一般是相应客户端的读写请求，而从主同步数据，当主挂掉之后就会从follower里投票选举一个leader出来。</p>
<p>另外，可以用<code>jps</code>查看zk的进程，这个是zk的整个工程的main</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jps</span></span><br><span class="line">48642 QuorumPeerMain</span><br><span class="line">19551 Jps</span><br></pre></td></tr></table></figure>

<h2 id="搭建kafka集群"><a href="#搭建kafka集群" class="headerlink" title="搭建kafka集群"></a>搭建kafka集群</h2><h3 id="安装配置kafka"><a href="#安装配置kafka" class="headerlink" title="安装配置kafka"></a>安装配置kafka</h3><h4 id="安装kafka"><a href="#安装kafka" class="headerlink" title="安装kafka"></a>安装kafka</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> ~</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">pwd</span></span></span><br><span class="line">/home/work</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://www.apache.org/dyn/closer.cgi?path=/kafka/2.0.0/kafka_2.12-2.0.0.tgz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/work/opt/kafka</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -zxvf /home/work/kafka_2.12-2.0.0.tgz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> kafkalogs <span class="comment"># 创建kafka消息目录，主要存放kafka消息</span></span></span><br></pre></td></tr></table></figure>
<h4 id="配置kafka"><a href="#配置kafka" class="headerlink" title="配置kafka"></a>配置kafka</h4><p>进入到config目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /home/work/opt/kafka/kafka_2.11-2.0.0/config</span><br></pre></td></tr></table></figure>

<p>主要关注：<code>server.properties</code>这个文件即可，我们可以发现在目录下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll</span></span><br><span class="line">total 68</span><br><span class="line">-rw-r--r-- 1 work work  906 Jul 24 22:17 connect-console-sink.properties</span><br><span class="line">-rw-r--r-- 1 work work  909 Jul 24 22:17 connect-console-source.properties</span><br><span class="line">-rw-r--r-- 1 work work 5321 Jul 24 22:17 connect-distributed.properties</span><br><span class="line">-rw-r--r-- 1 work work  883 Jul 24 22:17 connect-file-sink.properties</span><br><span class="line">-rw-r--r-- 1 work work  881 Jul 24 22:17 connect-file-source.properties</span><br><span class="line">-rw-r--r-- 1 work work 1111 Jul 24 22:17 connect-log4j.properties</span><br><span class="line">-rw-r--r-- 1 work work 2262 Jul 24 22:17 connect-standalone.properties</span><br><span class="line">-rw-r--r-- 1 work work 1221 Jul 24 22:17 consumer.properties</span><br><span class="line">-rw-r--r-- 1 work work 4727 Jul 24 22:17 log4j.properties</span><br><span class="line">-rw-r--r-- 1 work work 1919 Jul 24 22:17 producer.properties</span><br><span class="line">-rw-r--r-- 1 work work 7025 Oct 24 11:42 server.properties</span><br><span class="line">-rw-r--r-- 1 work work 1032 Jul 24 22:17 tools-log4j.properties</span><br><span class="line">-rw-r--r-- 1 work work 1169 Jul 24 22:17 trogdor.conf</span><br><span class="line">-rw-r--r-- 1 work work 1023 Jul 24 22:17 zookeeper.properties</span><br></pre></td></tr></table></figure>
<p>有很多文件，这里可以发现有Zookeeper文件，我们可以根据Kafka内带的zk集群来启动，但是建议使用独立的zk集群。<br>修改配置文件<code>server.properties</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this work <span class="keyword">for</span> additional information regarding copyright ownership.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(the <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance with</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">limitations under the License.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">see kafka.server.KafkaConfig <span class="keyword">for</span> additional details and defaults</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The <span class="built_in">id</span> of the broker. This must be <span class="built_in">set</span> to a unique <span class="built_in">integer</span> <span class="keyword">for</span> each broker.</span></span><br><span class="line">broker.id=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Socket Server Settings #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The address the socket server listens on. It will get the value returned from</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">java.net.InetAddress.getCanonicalHostName() <span class="keyword">if</span> not configured.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  FORMAT:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  EXAMPLE:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">listeners=PLAINTEXT://:9092</span></span><br><span class="line"></span><br><span class="line">host.name=10.159.1.40</span><br><span class="line">port=19092</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Hostname and port the broker will advertise to producers and consumers. If not <span class="built_in">set</span>,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it uses the value <span class="keyword">for</span> <span class="string">&quot;listeners&quot;</span> <span class="keyword">if</span> configured.  Otherwise, it will use the value</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">returned from java.net.InetAddress.getCanonicalHostName().</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">advertised.listeners=PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Maps listener names to security protocols, the default is <span class="keyword">for</span> them to be the same. See the config documentation <span class="keyword">for</span> more details</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of threads that the server uses <span class="keyword">for</span> receiving requests from the network and sending responses to the network</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of threads that the server uses <span class="keyword">for</span> processing requests, <span class="built_in">which</span> may include disk I/O</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The send buffer (SO_SNDBUF) used by the socket server</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The receive buffer (SO_RCVBUF) used by the socket server</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The maximum size of a request that the socket server will accept (protection against OOM)</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Log Basics #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A comma separated list of directories under <span class="built_in">which</span> to store <span class="built_in">log</span> files</span></span><br><span class="line">log.dirs=/home/work/opt/kafka/kafkalogs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The default number of <span class="built_in">log</span> partitions per topic. More partitions allow greater</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">parallelism <span class="keyword">for</span> consumption, but this will also result <span class="keyword">in</span> more files across</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the brokers.</span></span><br><span class="line">num.partitions=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of threads per data directory to be used <span class="keyword">for</span> <span class="built_in">log</span> recovery at startup and flushing at shutdown.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This value is recommended to be increased <span class="keyword">for</span> installations with data <span class="built_in">dirs</span> located <span class="keyword">in</span> RAID array.</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Internal Topic Settings  #############################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The replication <span class="built_in">factor</span> <span class="keyword">for</span> the group metadata internal topics <span class="string">&quot;__consumer_offsets&quot;</span> and <span class="string">&quot;__transaction_state&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For anything other than development testing, a value greater than 1 is recommended <span class="keyword">for</span> to ensure availability such as 3.</span></span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Log Flush Policy #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Messages are immediately written to the filesystem but by default we only fsync() to <span class="built_in">sync</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the OS cache lazily. The following configurations control the flush of data to disk.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">There are a few important trade-offs here:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   1. Durability: Unflushed data may be lost <span class="keyword">if</span> you are not using replication.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The settings below allow one to configure the flush policy to flush data after a period of time or</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">every N messages (or both). This can be <span class="keyword">done</span> globally and overridden on a per-topic basis.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log.flush.interval.messages=10000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The maximum amount of time a message can sit <span class="keyword">in</span> a <span class="built_in">log</span> before we force a flush</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log.flush.interval.ms=1000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Log Retention Policy #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The following configurations control the disposal of <span class="built_in">log</span> segments. The policy can</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">be <span class="built_in">set</span> to delete segments after a period of time, or after a given size has accumulated.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">from the end of the <span class="built_in">log</span>.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The minimum age of a <span class="built_in">log</span> file to be eligible <span class="keyword">for</span> deletion due to age</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A size-based retention policy <span class="keyword">for</span> logs. Segments are pruned from the <span class="built_in">log</span> unless the remaining</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">segments drop below log.retention.bytes. Functions independently of log.retention.hours.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">log.retention.bytes=1073741824</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The maximum size of a <span class="built_in">log</span> segment file. When this size is reached a new <span class="built_in">log</span> segment will be created.</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The interval at <span class="built_in">which</span> <span class="built_in">log</span> segments are checked to see <span class="keyword">if</span> they can be deleted according</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to the retention policies</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Zookeeper #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Zookeeper connection string (see zookeeper docs <span class="keyword">for</span> details).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is a comma separated host:port pairs, each corresponding to a zk</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">server. e.g. <span class="string">&quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">You can also append an optional <span class="built_in">chroot</span> string to the urls to specify the</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">root directory <span class="keyword">for</span> all kafka znodes.</span></span><br><span class="line">zookeeper.connect=10.159.1.40:12181,10.159.1.41:12181,10.159.1.42:12181</span><br><span class="line">message.max.byte=5242880</span><br><span class="line">default.replication.factor=2</span><br><span class="line">replica.fetch.max.bytes=5242880</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Timeout <span class="keyword">in</span> ms <span class="keyword">for</span> connecting to zookeeper</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ Group Coordinator Settings #############################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The following configuration specifies the time, <span class="keyword">in</span> milliseconds, that the GroupCoordinator will delay the initial consumer rebalance.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The rebalance will be further delayed by the value of group.initial.rebalance.delay.ms as new members <span class="built_in">join</span> the group, up to a maximum of max.poll.interval.ms.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The default value <span class="keyword">for</span> this is 3 seconds.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">We override this to 0 here as it makes <span class="keyword">for</span> a better out-of-the-box experience <span class="keyword">for</span> development and testing.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">However, <span class="keyword">in</span> production environments the default value of 3 seconds is more suitable as this will <span class="built_in">help</span> to avoid unnecessary, and potentially expensive, rebalances during application startup.</span></span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>

<h3 id="确认kafka是否部署成功"><a href="#确认kafka是否部署成功" class="headerlink" title="确认kafka是否部署成功"></a>确认kafka是否部署成功</h3><h4 id="启动kafka"><a href="#启动kafka" class="headerlink" title="启动kafka"></a>启动kafka</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> /home/work/opt/kafka/kafka_2.11-2.0.0/bin</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./kafka-server-start.sh  -daemon ../config/server.properties</span></span><br></pre></td></tr></table></figure>
<h4 id="检查是否启动成功-1"><a href="#检查是否启动成功-1" class="headerlink" title="检查是否启动成功"></a>检查是否启动成功</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jps <span class="comment"># 查看kafka是否启动成功</span></span></span><br><span class="line">48642 QuorumPeerMain</span><br><span class="line">55722 Jps</span><br><span class="line">25868 Kafka</span><br></pre></td></tr></table></figure>
<p><strong>tips：</strong>上述只是一台机器上搭建zookeeper和kafka，其他两台机器做上述同样操作</p>
<h2 id="测试kafka功能"><a href="#测试kafka功能" class="headerlink" title="测试kafka功能"></a>测试kafka功能</h2><h3 id="创建Topic"><a href="#创建Topic" class="headerlink" title="创建Topic"></a>创建Topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --create --zookeeper 10.159.1.41:12181 --replication-factor 2 --partitions 1 --topic test_mq</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--replication-factor 2 复制两份</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--partitions 1 创建1个分区</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--topic 主题为test_mq</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./kafka-topics.sh --list --zookeeper localhost:12181</span></span><br><span class="line">test_mq</span><br></pre></td></tr></table></figure>

<h3 id="生成-amp-消费消息"><a href="#生成-amp-消费消息" class="headerlink" title="生成&amp;消费消息"></a>生成&amp;消费消息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在10.159.1.40机器上执行,并在&gt;提示提示符后输入msg</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./kafka-console-producer.sh --broker-list 10.159.1.40:19092 --topic test_mq</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">test</span> mq message</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在10.159.1.41机器上执行，可以看到收到了消息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./kafka-console-consumer.sh --bootstrap-server PLAINTEXT://10.159.1.41:19092 --topic test_mq --from-beginning</span></span><br><span class="line">test mq message</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在10.159.1.42机器上执行，可以看到收到了消息</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./kafka-console-consumer.sh --bootstrap-server PLAINTEXT://10.159.1.42:19092 --topic test_mq --from-beginning</span></span><br><span class="line">test mq message</span><br></pre></td></tr></table></figure>
<p>至此，kafka集群搭建成功。后续还需要优化</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol>
<li>多boker调研</li>
<li>参数优化</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://m.fanruo.net/2019/05/19/2-3-lua-%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Frank Yu">
      <meta itemprop="description" content="初心 读书 知新 生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="凡 若">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/19/2-3-lua-%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-title-link" itemprop="url">2.3 lua 表达式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-19 23:44:58" itemprop="dateCreated datePublished" datetime="2019-05-19T23:44:58+08:00">2019-05-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 21:45:04" itemprop="dateModified" datetime="2022-04-23T21:45:04+08:00">2022-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
            <span id="/2019/05/19/2-3-lua-%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="post-meta-item leancloud_visitors" data-flag-title="2.3 lua 表达式" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/05/19/2-3-lua-%E8%A1%A8%E8%BE%BE%E5%BC%8F/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/05/19/2-3-lua-%E8%A1%A8%E8%BE%BE%E5%BC%8F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="算术表达式"><a href="#算术表达式" class="headerlink" title="算术表达式"></a>算术表达式</h2><p>Lua 的算术运算符如下表所示：</p>
<table>
<thead>
<tr>
<th>表达符</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>加法</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>除法</td>
</tr>
<tr>
<td>^</td>
<td>指数</td>
</tr>
<tr>
<td>%</td>
<td>取模</td>
</tr>
</tbody></table>
<p>实例</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">1</span> + <span class="number">2</span>) <span class="comment">--&gt;打印 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">5</span> / <span class="number">10</span>) <span class="comment">--&gt;打印 0.5。 这是Lua不同于c语言的</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">5.0</span> / <span class="number">10</span>) <span class="comment">--&gt;打印 0.5。 浮点数相除的结果是浮点数</span></span><br><span class="line"><span class="comment">-- print(10 / 0) --&gt;注意除数不能为0，计算的结果会出错</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">2</span> ^ <span class="number">10</span>) <span class="comment">--&gt;打印 1024。 求2的10次方</span></span><br><span class="line"><span class="keyword">local</span> num = <span class="number">1357</span></span><br><span class="line"><span class="built_in">print</span>(num % <span class="number">2</span>) <span class="comment">--&gt;打印 1</span></span><br><span class="line"><span class="built_in">print</span>((num % <span class="number">2</span>) == <span class="number">1</span>) <span class="comment">--&gt;打印 true。 判断num是否为奇数</span></span><br><span class="line"><span class="built_in">print</span>((num % <span class="number">5</span>) == <span class="number">0</span>) <span class="comment">--&gt;打印 false。判断num是否能被5整数</span></span><br></pre></td></tr></table></figure>
<h2 id="关系表达式"><a href="#关系表达式" class="headerlink" title="关系表达式"></a>关系表达式</h2><table>
<thead>
<tr>
<th>表达符</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>小于等于</td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>大于等于</td>
</tr>
<tr>
<td>&#x3D;&#x3D;</td>
<td>等于</td>
</tr>
<tr>
<td>~&#x3D;</td>
<td>不等于</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">1</span> &lt; <span class="number">2</span>) <span class="comment">--&gt;打印 true</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> == <span class="number">2</span>) <span class="comment">--&gt;打印 false</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> ~= <span class="number">2</span>) <span class="comment">--&gt;打印 true</span></span><br><span class="line"><span class="keyword">local</span> a, b = <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line"><span class="built_in">print</span>(a == b) <span class="comment">--&gt;打印 false</span></span><br></pre></td></tr></table></figure>
<p><strong>特别注意：</strong></p>
<ol>
<li>不同于C&#x2F;C++等语言，lua中的“不等于”是<code>~=</code>而非<code>!=</code>.</li>
<li>由于 Lua 字符串总是会被“内化”，即相同内容的字符串只会被保存一份，因此 Lua 字符串之间的相等性比较可以简化为其内部存储地址的比较。这意味着 Lua 字符串的相等性比较总是为 O(1). 而在其他编程语言中，字符串的相等性比较则通常为 O(n)，即需要逐个字节（ 或按若干个连续字节） 进行比较。</li>
<li>在使用“&#x3D;&#x3D;”做等于判断时，要注意对于 table, userdata 和函数， Lua 是作引用比较的。也就是说，只有当两个变量引用同一个对象时，才认为它们相等。如实例：<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a = &#123; x = <span class="number">1</span>, y = <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">local</span> b = &#123; x = <span class="number">1</span>, y = <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">if</span> a == b <span class="keyword">then</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a==b&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a~=b&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">---output:</span></span><br><span class="line">a~=b</span><br></pre></td></tr></table></figure>
<h2 id="逻辑表达式"><a href="#逻辑表达式" class="headerlink" title="逻辑表达式"></a>逻辑表达式</h2><table>
<thead>
<tr>
<th>表达符</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>and</td>
<td>逻辑与</td>
</tr>
<tr>
<td>or</td>
<td>逻辑或</td>
</tr>
<tr>
<td>not</td>
<td>逻辑非</td>
</tr>
</tbody></table>
</li>
</ol>
<p>Lua 中的 <code>and</code> 和 <code>or</code> 是不同于C&#x2F;C++语言的。在C&#x2F;C++语言中，<code>and</code> 和 <code>or</code> 只得到两个值 1 和 0，其中 1表示真，0 表示假。而 Lua 中 <code>and</code>和<code>or</code> 的执行结果返回的表达式的结果，而非<code>true</code>或者<code>flase</code>这类逻辑结果。也就是说：</p>
<ol>
<li><code>a and b</code> 如果 a 为 <code>nil</code>，则返回 a，否则返回 b;</li>
<li><code>a or b</code> 如果 a 为 <code>nil</code>，则返回 b，否则返回 a。<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">local</span> c = nil</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">local</span> d = 0</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">local</span> e = 100</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(c and d)</span></span><br><span class="line">nil</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(c and e)</span></span><br><span class="line">nil</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(d and e)</span></span><br><span class="line">100</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(c or d)</span></span><br><span class="line">0</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(c or e)</span></span><br><span class="line">100</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(not c)</span></span><br><span class="line">true</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">print</span>(not d)</span></span><br><span class="line">false</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>特别注意：</strong></p>
<ol>
<li>所有逻辑操作符将 false 和 nil 视作假，其他任何值视作真；</li>
<li>对于 and 和 or，“短路求值”；</li>
<li>对于 not，永远只返回 true 或者 false。</li>
</ol>
<h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><table>
<thead>
<tr>
<th>优先级(由高到低)</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
</tr>
<tr>
<td>not   # -</td>
</tr>
<tr>
<td>*   &#x2F;   %</td>
</tr>
<tr>
<td>+   -</td>
</tr>
<tr>
<td>..</td>
</tr>
<tr>
<td>&lt; &gt; &lt;&#x3D;  &gt;&#x3D;  &#x3D;&#x3D;  ~&#x3D;</td>
</tr>
<tr>
<td>and</td>
</tr>
<tr>
<td>or</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a, b = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">local</span> x, y = <span class="number">3</span>, <span class="number">4</span></span><br><span class="line"><span class="keyword">local</span> i = <span class="number">10</span></span><br><span class="line"><span class="keyword">local</span> res = <span class="number">0</span></span><br><span class="line">res = a + i &lt; b/<span class="number">2</span> + <span class="number">1</span> <span class="comment">--&gt;等价于res = (a + i) &lt; ((b/2) + 1)</span></span><br><span class="line">res = <span class="number">5</span> + x^<span class="number">2</span>*<span class="number">8</span> <span class="comment">--&gt;等价于res = 5 + ((x^2) * 8)</span></span><br><span class="line">res = a &lt; y <span class="keyword">and</span> y &lt;=x <span class="comment">--&gt;等价于res = (a &lt; y) and (y &lt;= x)</span></span><br></pre></td></tr></table></figure>
<p><strong>tips</strong></p>
<ol>
<li>若不确定某些操作符的优先级，就应显示地用括号来指定运算顺序。这样做还可以提高代码的可读性。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Frank Yu</p>
  <div class="site-description" itemprop="description">初心 读书 知新 生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-nd.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frank Yu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">71k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:05</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'XfIP95Pi6OxukxBHk9FcG87i-gzGzoHsz',
      appKey     : 'XeAkYB2bUv8IE0MYbwhsD3By',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : ,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
